@model VAYTIEN.Models.ThongTinVayViewModel

<h2 class="text-primary">Th√¥ng Tin T·∫•t C·∫£ H·ª£p ƒê·ªìng Vay</h2>
<p class="alert alert-info">
    <strong>T·ªïng s·ªë ti·ªÅn ƒë√£ vay:</strong> @Model.TongSoTienVay.ToString("N0") VNƒê
</p>

@foreach (var hd in Model.HopDongs)
{
    <div class="card mb-4">
        <div class="card-header bg-secondary text-white">
            <strong>H·ª£p ƒë·ªìng #@hd.MaHopDong</strong> ‚Äî @hd.SoTienVay?.ToString("N0") VNƒê
        </div>
        <div class="card-body">
            <p><strong>Th·ªùi gian vay:</strong> @hd.NgayVay?.ToString("dd/MM/yyyy") ‚Üí @hd.NgayHetHan?.ToString("dd/MM/yyyy")</p>

            @{
                // ‚úÖ KH√îNG t·∫°o gi·∫£ n·ªØa
                var lichTraTam = hd.LichTra ?? new List<VAYTIEN.Models.LichTraViewModel>();

                var kyCanThanhToan = lichTraTam
                .Where(x => (x.TrangThai?.Trim() == "Ch∆∞a tr·∫£") && x.NgayTra.HasValue)
                .OrderBy(x => x.KyHanThu)
                .FirstOrDefault();
            }

            @if (kyCanThanhToan != null)
            {
                <div class="mb-3 p-2 border rounded bg-light">
                    <strong>üîî Th√°ng c·∫ßn thanh to√°n:</strong> @kyCanThanhToan.NgayTra?.ToString("MM/yyyy") ‚Äî
                    <strong>S·ªë ti·ªÅn:</strong> @kyCanThanhToan.SoTienPhaiTra?.ToString("N0") VNƒê

                    <form method="get" asp-controller="ThanhToan" asp-action="ChiTiet" class="d-inline ms-3">
                        <input type="hidden" name="maHopDong" value="@hd.MaHopDong" />
                        <input type="hidden" name="kyHanThu" value="@kyCanThanhToan.KyHanThu" />
                        <button type="submit" class="btn btn-sm btn-success">Thanh to√°n k·ª≥ n√†y</button>
                    </form>
                </div>
            }

            <table class="table table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>K·ª≥ h·∫°n</th>
                        <th>Ng√†y tr·∫£</th>
                        <th>S·ªë ti·ªÅn</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>Thanh to√°n</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in lichTraTam.OrderBy(x => x.KyHanThu))
                    {
                        var trangThai = item.TrangThai?.Trim() ?? "Ch∆∞a tr·∫£";
                        var isChuaTra = trangThai == "Ch∆∞a tr·∫£";

                        <tr>
                            <td>@item.KyHanThu</td>
                            <td>@item.NgayTra?.ToString("dd/MM/yyyy")</td>
                            <td>@item.SoTienPhaiTra?.ToString("N0") VNƒê</td>
                            <td>
                                @if (trangThai == "ƒê√£ tr·∫£")
                                {
                                    <span class="badge bg-success">ƒê√£ tr·∫£</span>
                                }
                                else if (trangThai == "Ch∆∞a tr·∫£")
                                {
                                    <span class="badge bg-warning text-dark">Ch∆∞a tr·∫£</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">@trangThai</span>
                                }
                            </td>
                            <td>
                                @if (isChuaTra)
                                {
                                    <form method="get" asp-controller="ThanhToan" asp-action="ChiTiet">
                                        <input type="hidden" name="maHopDong" value="@hd.MaHopDong" />
                                        <input type="hidden" name="kyHanThu" value="@item.KyHanThu" />
                                        <button type="submit" class="btn btn-sm btn-danger">Thanh to√°n</button>
                                    </form>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
}
